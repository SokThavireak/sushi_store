<div class="max-w-5xl mx-auto bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden my-10">
  
  <div class="p-6 flex justify-between items-center border-b border-gray-100 bg-gray-50">
    <div>
        <h3 class="font-bold text-gray-800 text-lg">Daily Stock Count</h3>
        <p class="text-xs text-gray-500">Log physical inventory for <%= new Date().toLocaleDateString() %></p>
    </div>
    <div class="text-right">
        <span class="block text-xs font-bold text-gray-400 uppercase">Location</span>
        <span class="font-bold text-indigo-600"><%= locationName %></span>
    </div>
  </div>

  <div class="p-8">
    
    <% if (alreadySubmitted) { %>
        <div class="bg-green-50 border border-green-200 rounded-xl p-8 text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Stock Count Submitted</h3>
            <p class="text-gray-500 mb-6">You have already submitted the stock count for <b><%= new Date().toLocaleDateString() %></b>.</p>
            <a href="/manager/daily-stock/history" class="text-indigo-600 font-bold hover:underline">View History</a>
        </div>
    <% } else { %>

    <form id="dailyStockForm" onsubmit="submitDailyStock(event)" class="space-y-8">
        
        <% const categories = ['Cook', 'Drink', 'Supplies', 'Packaging']; %>
        
        <% categories.forEach(cat => { 
             const catItems = masterItems.filter(i => i.category === cat);
             if (catItems.length > 0) {
        %>
            <div class="border border-gray-200 rounded-xl overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center gap-2">
                    <% if (cat === 'Cook') { %> <i class="fa-solid fa-utensils text-gray-400"></i> <% } %>
                    <% if (cat === 'Drink') { %> <i class="fa-solid fa-glass-water text-gray-400"></i> <% } %>
                    <h4 class="font-bold text-gray-700"><%= cat %> Inventory</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-0 divide-y md:divide-y-0 md:divide-x divide-gray-100 bg-white">
                    <% catItems.forEach(item => { %>
                        <div class="p-4 flex items-center justify-between group hover:bg-gray-50 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 overflow-hidden">
                                    <% if(item.image_url) { %>
                                        <img src="<%= item.image_url %>" class="w-full h-full object-cover">
                                    <% } else { %>
                                        <i class="fa-solid fa-box text-xs"></i>
                                    <% } %>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-800"><%= item.name %></p>
                                    <p class="text-[10px] text-gray-400 uppercase"><%= item.unit || 'Unit' %></p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <input type="hidden" name="items[<%= item.id %>][name]" value="<%= item.name %>">
                                <input type="hidden" name="items[<%= item.id %>][category]" value="<%= item.category %>">
                                <input type="hidden" name="items[<%= item.id %>][unit]" value="<%= item.unit %>">
                                
                                <input 
                                    type="number" 
                                    name="items[<%= item.id %>][quantity]" 
                                    min="0" 
                                    placeholder="0" 
                                    class="w-20 text-center bg-gray-50 border border-gray-200 rounded-lg p-2 font-bold focus:border-indigo-500 focus:outline-none"
                                >
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        <% } }) %>

        <div class="flex justify-end pt-4">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex items-center gap-2">
                <i class="fa-solid fa-save"></i> Save Today's Count
            </button>
        </div>
    </form>
    
    <% } %>
  </div>
</div>

<script>
    async function submitDailyStock(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = { items: [] };

        // Convert weird FormData structure to clean JSON array
        // We iterate inputs to build the array
        const inputs = form.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            if(input.value !== '') { // Only send items that have a value entered
                const parent = input.closest('.flex'); // Get parent container
                data.items.push({
                    name: parent.querySelector('input[name*="[name]"]').value,
                    category: parent.querySelector('input[name*="[category]"]').value,
                    unit: parent.querySelector('input[name*="[unit]"]').value,
                    quantity: input.value
                });
            }
        });

        if(data.items.length === 0) return alert("Please enter at least one quantity.");

        try {
            const res = await fetch('/api/manager/daily-stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if(res.ok) window.location.reload();
            else alert("Error saving stock count");
        } catch(err) {
            console.error(err);
            alert("Server Error");
        }
    }
</script>