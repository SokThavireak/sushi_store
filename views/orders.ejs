<div class="max-w-6xl mx-auto mt-10 px-4 mb-20">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">My Orders</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Track your order history and status</p>
        </div>
        <a href="/menu" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2">
            <i class="fa-solid fa-utensils"></i> Order More
        </a>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transition-colors">
        
        <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
            <h3 class="font-bold text-gray-800 dark:text-white text-lg">Order List</h3>
            <span class="text-xs font-bold bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded-full">
                <%= typeof orders !== 'undefined' ? orders.length : 0 %> Orders
            </span>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 dark:bg-gray-900 text-gray-500 dark:text-gray-400 text-sm uppercase font-bold">
                    <tr>
                        <th class="p-5">ID</th>
                        <th class="p-5">Date</th>
                        <th class="p-5">Pickup Location</th>
                        <th class="p-5">Payment</th>
                        <th class="p-5">Total</th>
                        <th class="p-5">Status</th>
                        <th class="p-5 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    <% if (typeof orders !== 'undefined' && orders.length > 0) { %>
                        <% orders.forEach(order => { %>
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition duration-200">
                                
                                <td class="p-5 font-mono text-sm text-gray-600 dark:text-gray-400">
                                    #<%= order.id %>
                                </td>

                                <td class="p-5 text-sm font-medium text-gray-700 dark:text-white">
                                    <%= new Date(order.created_at).toLocaleDateString() %>
                                    <span class="text-xs text-gray-400 block font-normal"><%= new Date(order.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></span>
                                </td>

                                <td class="p-5 text-sm text-gray-600 dark:text-gray-300">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-store text-gray-400"></i>
                                        <%= order.pickup_location %>
                                    </div>
                                    <% if(order.table_number) { %>
                                        <div class="mt-1">
                                            <span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">
                                                Table <%= order.table_number %>
                                            </span>
                                        </div>
                                    <% } %>
                                </td>

                                <td class="p-5">
                                    <span class="px-2 py-1 rounded text-xs font-bold <%= order.payment_method === 'QR' ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400' : 'bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400' %>">
                                        <%= order.payment_method %>
                                    </span>
                                </td>

                                <td class="p-5 font-bold text-gray-800 dark:text-white">
                                    <%= Number(order.total_price).toFixed(2) %> $
                                </td>

                                <td class="p-5">
                                    <% 
                                        let statusColor = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                                        if(order.status === 'Completed') statusColor = 'bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400';
                                        if(order.status === 'Cancelled') statusColor = 'bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-400';
                                        if(order.status === 'Refunded') statusColor = 'bg-purple-100 text-purple-600 dark:bg-purple-900/40 dark:text-purple-400';
                                        if(order.status === 'Pending') statusColor = 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/40 dark:text-yellow-400';
                                        if(order.status === 'Processing') statusColor = 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400';
                                        
                                        if(order.status === 'Cancel Requested' || order.status === 'Refund Requested') 
                                            statusColor = 'bg-orange-100 text-orange-700 border border-orange-200 animate-pulse';
                                    %>
                                    <span class="px-3 py-1 rounded text-xs font-bold <%= statusColor %>">
                                        <%= order.status %>
                                    </span>
                                </td>

                                <td class="p-5 text-right">
                                    <% if (order.status === 'Pending') { %>
                                        <form action="/orders/request-cancel/<%= order.id %>" method="POST" onsubmit="return confirm('Are you sure you want to cancel this order?');">
                                            <button type="submit" class="px-3 py-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 text-xs font-bold transition shadow-sm border border-red-100 dark:border-red-800">
                                                Request Cancel
                                            </button>
                                        </form>
                                    <% } else if (order.status === 'Completed') { %>
                                        <form action="/orders/request-refund/<%= order.id %>" method="POST" onsubmit="return confirm('Request a refund for this order?');">
                                            <button type="submit" class="px-3 py-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 text-xs font-bold transition shadow-sm border border-blue-100 dark:border-blue-800">
                                                Request Refund
                                            </button>
                                        </form>
                                    <% } else { %>
                                        <span class="text-gray-300 dark:text-gray-600 text-xs italic">No actions</span>
                                    <% } %>
                                </td>

                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="p-12 text-center text-gray-400 dark:text-gray-500">
                                <i class="fa-solid fa-basket-shopping text-4xl mb-3 block opacity-20"></i>
                                No orders found.
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<button id="theme-toggle" class="fixed bottom-6 right-6 w-12 h-12 bg-gray-900 dark:bg-yellow-400 text-white dark:text-gray-900 rounded-full shadow-lg z-[9999] flex items-center justify-center transition-transform hover:scale-110 focus:outline-none">
    <i class="fa-solid fa-moon dark:hidden text-lg"></i>
    <i class="fa-solid fa-sun hidden dark:block text-lg"></i>
</button>

<script>
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // --- NOTIFICATION SYSTEM ---
    function showNotification(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const isError = type === 'error';
        const bgClass = isError ? 'bg-red-500' : 'bg-green-500';
        const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';
        
        toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform pointer-events-auto min-w-[300px] border-2 border-white/20`;
        toast.style.animation = 'slideIn 0.5s forwards';
        
        toast.innerHTML = `
            <div class="text-2xl">${icon}</div>
            <div class="font-bold text-sm">${message}</div>
        `;
        
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // Helper to confirm action and show "Processing..." alert
    function confirmAction(e, message) {
        if(!confirm(message)) {
            e.preventDefault();
            return false;
        }
        showNotification('Processing Request...', 'success');
        return true;
    }
</script>