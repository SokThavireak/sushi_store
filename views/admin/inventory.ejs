<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">

  <div class="p-6 flex justify-between items-center border-b border-gray-100">
    <h3 class="font-bold text-gray-800 text-lg">Product Inventory</h3>
    <button onclick="toggleModal('add-modal')"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
      <i class="fa-solid fa-plus"></i> Add New Product
    </button>
  </div>

  <div class="px-6 py-2 bg-gray-50 border-b border-gray-100">
    <div class="relative">
      <input type="text" id="search-input" onkeyup="captureAndFilter()" placeholder="Type to search product name..."
        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-blue-500 transition-colors" />
      <div class="absolute left-3 top-2.5 text-gray-400">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
    </div>
  </div>

  <div class="p-8 bg-gray-50 min-h-screen">

    <% 
      // 1. SETUP CATEGORIES (Ensure "On Sale" and "Most Sales" exist) 
      let displayCategories = categories ? JSON.parse(JSON.stringify(categories)) : []; 

      // Force add "On Sale" if it's missing 
      if (!displayCategories.some(c => c.name === 'On Sale')) {
        displayCategories.unshift({ name: 'On Sale' });
      }

      // Force add "Most Sales" if it's missing
      if (!displayCategories.some(c => c.name === 'Most Sales')) {
        displayCategories.unshift({ name: 'Most Sales' });
      }

      // 2. SORT ORDER: On Sale -> Most Sales -> Others
      displayCategories.sort((a, b) => {
        if (a.name === 'On Sale') return -1;
        if (b.name === 'On Sale') return 1;
        if (a.name === 'Most Sales') return -1;
        if (b.name === 'Most Sales') return 1;
        return 0;
      });
    %>

    <% displayCategories.forEach(function(category) { %>

      <% 
        let categoryProducts = []; 
        
        // --- FILTER LOGIC --- 
        if (category.name === 'On Sale') { 
            // Capture ALL products with a discount 
            categoryProducts = products ? products.filter(p => 
              p.discount_type && p.discount_type !== 'none' && p.discount_value > 0
            ) : [];

        } else if (category.name === 'Most Sales') {
            // Capture Best Sellers
            categoryProducts = products ? products.filter(p => p.is_best_seller === true) : [];

        } else {
            // Normal Category Filter
            categoryProducts = products ? products.filter(p => p.category === category.name) : [];
        }
      %>

      <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <% if (category.name === 'On Sale') { %>
            ðŸ’° Big Deals (On Sale)
          <% } else if (category.name === 'Most Sales') { %>
            ðŸ”¥ Best Sellers (Most Sales)
          <% } else if (category.name === 'Roll') { %>
            Most Wanted (Rolls)
          <% } else { %>
            <%= category.name %> Collection
          <% } %>

          <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-full">
            <%= categoryProducts.length %> items
          </span>
        </h2>

        <% if (categoryProducts.length > 0) { %>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <% categoryProducts.forEach(function(product) { %>

              <div class="bg-white rounded-[2rem] p-4 shadow-sm hover:shadow-md transition duration-300 relative group">

                <% if (product.is_best_seller) { %>
                  <span class="absolute top-7 left-7 z-10 bg-yellow-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">TOP HIT</span>
                <% } %>

                <% 
                  // PRICE CALCULATION LOGIC 
                  let finalPrice = Number(product.price);
                  let hasDiscount = false; 

                  if (product.discount_type === 'percentage' && product.discount_value > 0) {
                      finalPrice = product.price - (product.price * (product.discount_value / 100));
                      hasDiscount = true;
                  } else if (product.discount_type === 'subtract' && product.discount_value > 0) {
                      finalPrice = product.price - product.discount_value;
                      hasDiscount = true;
                  }

                  if (finalPrice < 0) finalPrice = 0;
                  
                  // Format price nicely 
                  finalPrice = Math.round(finalPrice * 100) / 100;
                %>

                <% if (hasDiscount) { %>
                  <span class="absolute top-7 right-7 z-10 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">
                    <% if (product.discount_type === 'percentage') { %>
                      -<%= product.discount_value %>%
                    <% } else { %>
                      -<%= product.discount_value %>$
                    <% } %>
                  </span>
                <% } %>

                <div class="relative h-48 w-full rounded-2xl overflow-hidden mb-4 bg-gray-100">
                  <% if (product.image_url) { %>
                    <img src="<%= product.image_url %>" alt="<%= product.name %>" class="w-full h-full object-cover" />
                  <% } else { %>
                    <div class="w-full h-full flex items-center justify-center text-gray-300">
                      <i class="fa-solid fa-image text-2xl"></i>
                    </div>
                  <% } %>
                </div>

                <div class="px-1">
                  <h3 class="font-bold text-gray-900 text-lg leading-tight mb-1">
                    <%= product.name %>
                  </h3>
                  <p class="text-xs text-gray-400 mb-4 font-medium">
                    <%= product.category %> Item
                  </p>

                  <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                      <% if (hasDiscount) { %>
                        <span class="text-xs text-gray-400 line-through">
                          <%= product.price %> áŸ›
                        </span>
                        <span class="font-bold text-red-600 text-lg">
                          <%= finalPrice %> áŸ›
                        </span>
                      <% } else { %>
                        <span class="font-bold text-gray-900 text-lg">
                          <%= product.price %> áŸ›
                        </span>
                      <% } %>
                    </div>

                    <div class="flex gap-2">
                      <button data-product="<%= JSON.stringify(product) %>" onclick="openEditModal(this)"
                        class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition text-gray-600">
                        <i class="fa-solid fa-pen"></i>
                      </button>

                      <form action="/admin/inventory/delete/<%= product.id %>" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this item?');">
                        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center bg-gray-50/50">
            <p class="text-gray-400 text-sm">No products in <%= category.name %> yet.</p>
            <% if (category.name !== 'On Sale' && category.name !== 'Most Sales') { %>
              <button onclick="toggleModal('add-modal')" class="text-blue-600 text-sm font-bold mt-2 hover:underline">
                + Add a <%= category.name %> Product
              </button>
            <% } %>
          </div>
        <% } %>
      </div>
    <% }); %>
  </div>
</div>

<div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <h3 class="text-lg font-bold text-gray-800">Add New Product</h3>
      <button onclick="toggleModal('add-modal')" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <form action="/admin/inventory/add" method="POST" enctype="multipart/form-data" class="p-6 space-y-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
        <input type="text" name="name" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
          <select name="category" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(cat => {
                // Skip virtual categories in the dropdown
                if(cat.name !== 'On Sale' && cat.name !== 'Most Sales') { %>
                  <option value="<%= cat.name %>">
                    <%= cat.name %>
                  </option>
                <% } 
              }) %>
            <% } else { %>
              <option value="" disabled>No Categories Found</option>
            <% } %>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
          <input type="number" name="price" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Type</label>
          <select name="discount_type" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="none">No Discount</option>
            <option value="percentage">Percentage (%)</option>
            <option value="subtract">Subtract Amount ($)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Value</label>
          <input type="number" name="discount_value" value="0" step="0.01"
            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image</label>
          <input type="file" name="image" class="w-full text-sm" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Is Best Seller?</label>
          <select name="is_best_seller" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="false">No (Normal Product)</option>
            <option value="true">Yes (Add to Most Sales)</option>
          </select>
        </div>
      </div>
      <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold mt-2">
        Save Product
      </button>
    </form>
  </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <h3 class="text-lg font-bold text-gray-800">Edit Product</h3>
      <button onclick="toggleModal('edit-modal')" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="edit-id" />
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
        <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
          <select id="edit-category" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(cat => {
                if(cat.name !== 'On Sale' && cat.name !== 'Most Sales') { %>
                  <option value="<%= cat.name %>">
                    <%= cat.name %>
                  </option>
                <% } 
              }) %>
            <% } %>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
          <input type="number" id="edit-price" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Type</label>
          <select id="edit-discount_type" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="none">No Discount</option>
            <option value="percentage">Percentage (%)</option>
            <option value="subtract">Subtract Amount ($)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Value</label>
          <input type="number" id="edit-discount_value" step="0.01"
            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
          <input type="text" id="edit-image_url" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Is Best Seller?</label>
          <select id="edit-is_best_seller" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>

      <button onclick="submitEdit()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold mt-2">
        Update Product
      </button>
    </div>
  </div>
</div>

<script>
  function captureAndFilter() {
    const captureValue = document.getElementById("search-input").value.toLowerCase();
    const productCards = document.querySelectorAll(".group");
    productCards.forEach((card) => {
      const productName = card.querySelector("h3").innerText.toLowerCase();
      card.style.display = productName.includes(captureValue) ? "" : "none";
    });
  }

  function toggleModal(id) {
    document.getElementById(id).classList.toggle("hidden");
  }

  function openEditModal(buttonElement) {
    const productData = buttonElement.getAttribute("data-product");
    const product = JSON.parse(productData);

    document.getElementById("edit-id").value = product.id;
    document.getElementById("edit-name").value = product.name;
    document.getElementById("edit-category").value = product.category;
    document.getElementById("edit-price").value = product.price;
    
    // NEW: Load Discount Data
    document.getElementById("edit-discount_type").value = product.discount_type || 'none';
    document.getElementById("edit-discount_value").value = product.discount_value || 0;
    
    document.getElementById("edit-image_url").value = product.image_url;
    document.getElementById("edit-is_best_seller").value = product.is_best_seller ? "true" : "false";
    toggleModal("edit-modal");
  }

  function deleteItem(id) {
    // 1. Confirm with the user
    if (!confirm("Are you sure you want to delete this item?")) return;
    
    // 2. Send DELETE request to the server
    fetch('/api/inventory/' + id, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          // 3. Show error if server blocked it (e.g., item has sales history)
          alert(data.error);
        } else {
          // 4. Reload page if successful
          window.location.reload();
        }
      })
      .catch(err => {
        console.error(err);
        alert("An error occurred.");
      });
  }

  async function submitEdit() {
    const id = document.getElementById("edit-id").value;
    const data = {
      name: document.getElementById("edit-name").value,
      category: document.getElementById("edit-category").value,
      price: document.getElementById("edit-price").value,
      // NEW: Send Discount Data
      discount_type: document.getElementById("edit-discount_type").value,
      discount_value: document.getElementById("edit-discount_value").value,
      image_url: document.getElementById("edit-image_url").value,
      is_best_seller: document.getElementById("edit-is_best_seller").value === "true"
    };
    
    try {
      const res = await fetch(`/api/inventory/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (res.ok) window.location.reload();
      else alert("Error updating item");
    } catch (err) { console.error(err); }
  }
</script>