<style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
</style>

<div id="toast-container" class="fixed top-24 right-4 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
  <div class="p-6 flex justify-between items-center border-b border-gray-100">
    <h3 class="font-bold text-gray-800 text-lg">Product Inventory</h3>
    <button onclick="toggleModal('add-modal')"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
      <i class="fa-solid fa-plus"></i> Add New Product
    </button>
  </div>

  <div class="px-6 py-2 bg-gray-50 border-b border-gray-100">
    <div class="relative">
      <input type="text" id="search-input" onkeyup="captureAndFilter()" placeholder="Type to search product name..."
        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-blue-500 transition-colors" />
      <div class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
    </div>
  </div>

  <div class="p-8 bg-gray-50 min-h-screen">
      <% 
        let displayCategories = categories ? JSON.parse(JSON.stringify(categories)) : []; 
        if (!displayCategories.some(c => c.name === 'On Sale')) displayCategories.unshift({ name: 'On Sale' });
        if (!displayCategories.some(c => c.name === 'Most Sales')) displayCategories.unshift({ name: 'Most Sales' });
        displayCategories.sort((a, b) => {
            if (a.name === 'On Sale') return -1;
            if (b.name === 'On Sale') return 1;
            if (a.name === 'Most Sales') return -1;
            if (b.name === 'Most Sales') return 1;
            return 0;
        });
      %>
      <% displayCategories.forEach(function(category) { %>
          <% 
            let categoryProducts = []; 
            if (category.name === 'On Sale') { 
                categoryProducts = products ? products.filter(p => p.discount_type && p.discount_type !== 'none' && p.discount_value > 0) : [];
            } else if (category.name === 'Most Sales') {
                categoryProducts = products ? products.filter(p => p.is_best_seller === true) : [];
            } else {
                categoryProducts = products ? products.filter(p => p.category === category.name) : [];
            }
          %>
          <div class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
              <%= category.name %> <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-full"><%= categoryProducts.length %> items</span>
            </h2>
            <% if (categoryProducts.length > 0) { %>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                 <% categoryProducts.forEach(function(product) { %>
                     <div class="bg-white rounded-[2rem] p-4 shadow-sm hover:shadow-md transition duration-300 relative group">
                        <div class="absolute bottom-4 right-4 flex gap-2">
                           <button data-product="<%= JSON.stringify(product) %>" onclick="openEditModal(this)"
                              class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition text-gray-600">
                              <i class="fa-solid fa-pen"></i>
                           </button>
                           <button onclick="deleteItem(<%= product.id %>)" class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center hover:bg-red-100 hover:text-red-600 transition text-red-500">
                              <i class="fa-solid fa-trash"></i>
                           </button>
                        </div>

                        <div class="relative h-48 w-full rounded-2xl overflow-hidden mb-4 bg-gray-100">
                            <img src="<%= product.image_url || '' %>" class="w-full h-full object-cover">
                        </div>
                        <h3 class="font-bold text-gray-900"><%= product.name %></h3>
                        <p class="text-gray-500 text-sm">$<%= product.price %></p>
                     </div>
                 <% }); %>
              </div>
            <% } else { %>
              <p class="text-gray-400 italic">No items.</p>
            <% } %>
          </div>
      <% }); %>
  </div>
</div>

<div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
        <h3 class="text-lg font-bold mb-4">Add Product</h3>
        <form onsubmit="submitAdd(event)" class="space-y-4">
            <input type="text" name="name" placeholder="Name" required class="w-full border p-2 rounded">
            <input type="number" name="price" placeholder="Price" required class="w-full border p-2 rounded">
            <select name="category" class="w-full border p-2 rounded">
                <% categories.forEach(c => { %><option value="<%= c.name %>"><%= c.name %></option><% }) %>
            </select>
            <button class="w-full bg-blue-600 text-white py-2 rounded font-bold">Save</button>
        </form>
        <button onclick="toggleModal('add-modal')" class="mt-2 text-gray-500 w-full">Cancel</button>
    </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
        <h3 class="text-lg font-bold mb-4">Edit Product</h3>
        <div class="space-y-4">
            <input type="hidden" id="edit-id">
            <input type="text" id="edit-name" class="w-full border p-2 rounded">
            <input type="number" id="edit-price" class="w-full border p-2 rounded">
            <select id="edit-category" class="w-full border p-2 rounded">
                 <% categories.forEach(c => { %><option value="<%= c.name %>"><%= c.name %></option><% }) %>
            </select>
            <input type="hidden" id="edit-discount_type">
             <input type="hidden" id="edit-discount_value">
             <input type="hidden" id="edit-image_url">
             <input type="hidden" id="edit-is_best_seller">

            <button onclick="submitEdit()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Update</button>
        </div>
        <button onclick="toggleModal('edit-modal')" class="mt-2 text-gray-500 w-full">Cancel</button>
    </div>
</div>

<script>
  function showNotification(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const isError = type === 'error';
      const bgClass = isError ? 'bg-red-500' : 'bg-green-500';
      const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';
      toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform pointer-events-auto min-w-[300px] border-2 border-white/20`;
      toast.style.animation = 'slideIn 0.5s forwards';
      toast.innerHTML = `<div class="text-2xl">${icon}</div><div class="font-bold text-sm">${message}</div>`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.animation = 'slideOut 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, 3000);
  }

  function toggleModal(id) { document.getElementById(id).classList.toggle("hidden"); }

  function openEditModal(btn) {
      const p = JSON.parse(btn.getAttribute("data-product"));
      document.getElementById("edit-id").value = p.id;
      document.getElementById("edit-name").value = p.name;
      document.getElementById("edit-category").value = p.category;
      document.getElementById("edit-price").value = p.price;
      // Populate other fields...
      toggleModal("edit-modal");
  }

  // 1. ADD ITEM (UPDATED)
  async function submitAdd(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      // NOTE: Because your original used form submission for file upload, 
      // we need to use fetch with FormData to keep image upload working.
      try {
          const res = await fetch('/admin/inventory/add', {
              method: 'POST',
              body: formData // Sends multipart/form-data automatically
          });
          if(res.ok) {
              showNotification("Product Added Successfully!");
              toggleModal('add-modal');
              setTimeout(() => window.location.reload(), 1500);
          } else {
              showNotification("Error adding product", 'error');
          }
      } catch(err) { console.error(err); showNotification("Server Error", 'error'); }
  }

  // 2. DELETE ITEM (UPDATED)
  function deleteItem(id) {
    if (!confirm("Are you sure you want to delete this item?")) return;
    fetch('/api/inventory/' + id, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showNotification(data.error, 'error');
        } else {
          showNotification("Product Deleted");
          setTimeout(() => window.location.reload(), 1000);
        }
      })
      .catch(err => { console.error(err); showNotification("Server Error", 'error'); });
  }

  // 3. EDIT ITEM (UPDATED)
  async function submitEdit() {
    const id = document.getElementById("edit-id").value;
    const data = {
      name: document.getElementById("edit-name").value,
      category: document.getElementById("edit-category").value,
      price: document.getElementById("edit-price").value,
      // Add other fields...
    };
    try {
      const res = await fetch(`/api/inventory/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (res.ok) {
          showNotification("Product Updated!");
          toggleModal('edit-modal');
          setTimeout(() => window.location.reload(), 1000);
      }
      else showNotification("Error updating item", 'error');
    } catch (err) { console.error(err); showNotification("Server Error", 'error'); }
  }
</script>