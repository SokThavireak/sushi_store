<style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
</style>

<% 
  let displayCategories = categories ? JSON.parse(JSON.stringify(categories)) : []; 
  if (!displayCategories.some(c => c.name === 'On Sale')) displayCategories.unshift({ name: 'On Sale' });
  if (!displayCategories.some(c => c.name === 'Most Sales')) displayCategories.unshift({ name: 'Most Sales' });
  displayCategories.sort((a, b) => {
      if (a.name === 'On Sale') return -1;
      if (b.name === 'On Sale') return 1;
      if (a.name === 'Most Sales') return -1;
      if (b.name === 'Most Sales') return 1;
      return 0;
  });
%>

<div id="toast-container" class="fixed top-24 right-4 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
  <div class="p-6 flex justify-between items-center border-b border-gray-100">
    <h3 class="font-bold text-gray-800 text-lg">Product Inventory</h3>
    <button onclick="toggleModal('add-modal')"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
      <i class="fa-solid fa-plus"></i> Add New Product
    </button>
  </div>

  <div class="px-6 py-2 bg-gray-50 border-b border-gray-100">
    <div class="relative">
      <input type="text" id="search-input" onkeyup="captureAndFilter()" placeholder="Type to search product name..."
        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-blue-500 transition-colors" />
      <div class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
    </div>
    
    <div class="pt-4 flex flex-wrap gap-2">
      <button onclick="filterInventory('all')" 
          class="inv-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-colors bg-blue-600 text-white shadow-sm">
          All
      </button>
      <% if (displayCategories) { %>
          <% displayCategories.forEach(function(cat) { %>
              <button onclick="filterInventory('<%= cat.name %>')" 
                  class="inv-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-colors bg-white text-gray-600 border border-gray-200 hover:bg-gray-100">
                  <%= cat.name %>
              </button>
          <% }); %>
      <% } %>
    </div>
  </div>

  <div class="p-8 bg-gray-50 min-h-screen">
      <% displayCategories.forEach(function(category) { %>
          <% 
            let categoryProducts = []; 
            if (category.name === 'On Sale') { 
                categoryProducts = products ? products.filter(p => p.discount_type && p.discount_type !== 'none' && p.discount_value > 0) : [];
            } else if (category.name === 'Most Sales') {
                categoryProducts = products ? products.filter(p => p.is_best_seller === true) : [];
            } else {
                categoryProducts = products ? products.filter(p => p.category === category.name) : [];
            }
          %>
          
          <div class="mb-12 inventory-section" data-category="<%= category.name %>">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
              <%= category.name %> <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-full"><%= categoryProducts.length %> items</span>
            </h2>
            <% if (categoryProducts.length > 0) { %>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                 <% categoryProducts.forEach(function(product) { %>
                     <div class="bg-white rounded-[2rem] p-4 shadow-sm hover:shadow-md transition duration-300 relative group product-card">
                        <div class="absolute bottom-4 right-4 flex gap-2">
                           <button data-product="<%= JSON.stringify(product) %>" onclick="openEditModal(this)"
                              class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition text-gray-600">
                              <i class="fa-solid fa-pen"></i>
                           </button>
                           <button onclick="deleteItem(<%= product.id %>)" class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center hover:bg-red-100 hover:text-red-600 transition text-red-500">
                              <i class="fa-solid fa-trash"></i>
                           </button>
                        </div>

                        <div class="relative h-48 w-full rounded-2xl overflow-hidden mb-4 bg-gray-100">
                            <img src="<%= product.image_url || '' %>" class="w-full h-full object-cover">
                        </div>
                        <h3 class="font-bold text-gray-900 product-name"><%= product.name %></h3>
                        <p class="text-gray-500 text-sm">$<%= product.price %></p>
                     </div>
                 <% }); %>
              </div>
            <% } else { %>
              <p class="text-gray-400 italic">No items.</p>
            <% } %>
          </div>
      <% }); %>
  </div>
</div>

<div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <h3 class="text-lg font-bold text-gray-800">Add New Product</h3>
      <button onclick="toggleModal('add-modal')" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <form action="/admin/inventory/add" method="POST" enctype="multipart/form-data" class="p-6 space-y-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
        <input type="text" name="name" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
          <select name="category" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(cat => {
                if(cat.name !== 'On Sale' && cat.name !== 'Most Sales') { %>
                  <option value="<%= cat.name %>"><%= cat.name %></option>
                <% } 
              }) %>
            <% } else { %>
              <option value="" disabled>No Categories Found</option>
            <% } %>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
          <input type="number" name="price" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Type</label>
          <select name="discount_type" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="none">No Discount</option>
            <option value="percentage">Percentage (%)</option>
            <option value="subtract">Subtract Amount ($)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Value</label>
          <input type="number" name="discount_value" value="0" step="0.01" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image</label>
          <input type="file" name="image" class="w-full text-sm" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Is Best Seller?</label>
          <select name="is_best_seller" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="false">No (Normal Product)</option>
            <option value="true">Yes (Add to Most Sales)</option>
          </select>
        </div>
      </div>
      <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold mt-2">
        Save Product
      </button>
    </form>
  </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <h3 class="text-lg font-bold text-gray-800">Edit Product</h3>
      <button onclick="toggleModal('edit-modal')" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="edit-id" />
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
        <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
          <select id="edit-category" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(cat => {
                if(cat.name !== 'On Sale' && cat.name !== 'Most Sales') { %>
                  <option value="<%= cat.name %>"><%= cat.name %></option>
                <% } 
              }) %>
            <% } %>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
          <input type="number" id="edit-price" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Type</label>
          <select id="edit-discount_type" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="none">No Discount</option>
            <option value="percentage">Percentage (%)</option>
            <option value="subtract">Subtract Amount ($)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount Value</label>
          <input type="number" id="edit-discount_value" step="0.01" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
          <input type="text" id="edit-image_url" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Is Best Seller?</label>
          <select id="edit-is_best_seller" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>

      <button onclick="submitEdit()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold mt-2">
        Update Product
      </button>
    </div>
  </div>
</div>

<script>
  function showNotification(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const isError = type === 'error';
      const bgClass = isError ? 'bg-red-500' : 'bg-green-500';
      const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';
      toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform pointer-events-auto min-w-[300px] border-2 border-white/20`;
      toast.style.animation = 'slideIn 0.5s forwards';
      toast.innerHTML = `<div class="text-2xl">${icon}</div><div class="font-bold text-sm">${message}</div>`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.animation = 'slideOut 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, 3000);
  }

  function toggleModal(id) { document.getElementById(id).classList.toggle("hidden"); }

  // SEARCH FILTER
  function captureAndFilter() {
      const term = document.getElementById('search-input').value.toLowerCase();
      document.querySelectorAll('.product-card').forEach(card => {
          const name = card.querySelector('.product-name').innerText.toLowerCase();
          if (term.length > 0) {
              card.parentElement.style.display = name.includes(term) ? 'block' : 'none';
          } else {
              card.parentElement.style.display = 'block'; // Show all if search clear
          }
      });
      // Re-trigger category filter if search is cleared
      if(term.length === 0) {
          const activeBtn = document.querySelector('.inv-filter-btn.bg-blue-600'); // Check for active class
          if(activeBtn) filterInventory(activeBtn.innerText.trim());
      }
  }

  function openEditModal(btn) {
      const p = JSON.parse(btn.getAttribute("data-product"));
      document.getElementById("edit-id").value = p.id;
      document.getElementById("edit-name").value = p.name;
      document.getElementById("edit-category").value = p.category;
      document.getElementById("edit-price").value = p.price;
      // Populate other fields...
      toggleModal("edit-modal");
  }

  // ADD ITEM
  async function submitAdd(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      try {
          const res = await fetch('/admin/inventory/add', {
              method: 'POST',
              body: formData 
          });
          if(res.ok) {
              showNotification("Product Added Successfully!");
              toggleModal('add-modal');
              setTimeout(() => window.location.reload(), 1500);
          } else {
              showNotification("Error adding product", 'error');
          }
      } catch(err) { console.error(err); showNotification("Server Error", 'error'); }
  }

  // DELETE ITEM
  function deleteItem(id) {
    if (!confirm("Are you sure you want to delete this item?")) return;
    fetch('/api/inventory/' + id, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showNotification(data.error, 'error');
        } else {
          showNotification("Product Deleted");
          setTimeout(() => window.location.reload(), 1000);
        }
      })
      .catch(err => { console.error(err); showNotification("Server Error", 'error'); });
  }

  // EDIT ITEM
  async function submitEdit() {
    const id = document.getElementById("edit-id").value;
    const data = {
      name: document.getElementById("edit-name").value,
      category: document.getElementById("edit-category").value,
      price: document.getElementById("edit-price").value,
      // Add other fields...
    };
    try {
      const res = await fetch(`/api/inventory/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (res.ok) {
          showNotification("Product Updated!");
          toggleModal('edit-modal');
          setTimeout(() => window.location.reload(), 1000);
      }
      else showNotification("Error updating item", 'error');
    } catch (err) { console.error(err); showNotification("Server Error", 'error'); }
  }

  // CATEGORY FILTER LOGIC
  function filterInventory(categoryName) {
      // 1. Button Styles
      document.querySelectorAll('.inv-filter-btn').forEach(btn => {
          const btnText = btn.innerText.trim();
          if (btnText === categoryName || (categoryName === 'all' && btnText === 'All')) {
              btn.className = "inv-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-colors bg-blue-600 text-white shadow-sm";
          } else {
              btn.className = "inv-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-colors bg-white text-gray-600 border border-gray-200 hover:bg-gray-100";
          }
      });

      // 2. Show/Hide Sections
      document.querySelectorAll('.inventory-section').forEach(div => {
          if (categoryName === 'all' || div.dataset.category === categoryName) {
              div.style.display = 'block';
          } else {
              div.style.display = 'none';
          }
      });
  }
</script>