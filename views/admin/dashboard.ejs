<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">Overview</h1>
        <p class="text-gray-500">Welcome back, <%= user.email.split('@')[0] %>!</p>
    </div>

    <form action="/admin/dashboard" method="GET" class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm flex items-center gap-2">
        <label class="text-xs font-bold text-gray-500 uppercase px-2">Store:</label>
        
        <% if (user.role === 'store_manager') { %>
            <span class="font-bold text-indigo-600 px-2 py-1 bg-indigo-50 rounded">
                <i class="fa-solid fa-store mr-1"></i> <%= currentFilter %>
            </span>
        <% } else { %>
            <select name="location" onchange="this.form.submit()" class="bg-transparent font-bold text-gray-700 outline-none cursor-pointer">
                <option value="All" <%= currentFilter === 'All' ? 'selected' : '' %>>All Locations</option>
                <% locations.forEach(loc => { %>
                    <option value="<%= loc.name %>" <%= currentFilter === loc.name ? 'selected' : '' %>>
                        <%= loc.name %>
                    </option>
                <% }) %>
            </select>
        <% } %>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase">Revenue (<%= currentFilter %>)</p>
            <h3 class="text-2xl font-bold text-indigo-900">$<%= totalRevenue %></h3>
        </div>
        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
            <i class="fa-solid fa-dollar-sign"></i>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase">Total Orders</p>
            <h3 class="text-2xl font-bold text-gray-800"><%= ordersCount %></h3>
        </div>
        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
            <i class="fa-solid fa-cart-shopping"></i>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase">Active Users</p>
            <h3 class="text-2xl font-bold text-gray-800"><%= userCount %></h3>
        </div>
        <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">
            <i class="fa-solid fa-users"></i>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase">Inventory</p>
            <h3 class="text-2xl font-bold text-gray-800"><%= productsCount %></h3>
        </div>
        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
            <i class="fa-solid fa-box"></i>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-gray-800">Sales Analytics</h3>
            <span class="text-sm text-gray-400">Last 7 Days (<%= currentFilter %>)</span>
        </div>
        <div class="h-64">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
        <h3 class="font-bold text-gray-800 mb-6">Order Status</h3>
        <div class="h-48 flex justify-center">
            <canvas id="statusChart"></canvas>
        </div>
        <div class="mt-6 text-center">
            <p class="text-sm text-gray-500">Based on filtered selection</p>
        </div>
    </div>
</div>

<script>
    // 1. Bar Chart Data
    const rawSales = <%- JSON.stringify(chartData) %>;
    const salesLabels = rawSales.map(d => d.day);
    const salesValues = rawSales.map(d => d.daily_sales);

    new Chart(document.getElementById('salesChart'), {
        type: 'bar',
        data: {
            labels: salesLabels,
            datasets: [{
                label: 'Revenue ($)',
                data: salesValues,
                backgroundColor: '#4f46e5',
                borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
    });

    // 2. Donut Chart Data (Dynamic Status)
    const rawStatus = <%- JSON.stringify(statusData) %>;
    // Map DB status to counts (default 0 if missing)
    const getCount = (status) => {
        const found = rawStatus.find(s => s.status === status);
        return found ? found.count : 0;
    };
    
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending', 'Cancelled', 'Processing'],
            datasets: [{
                data: [getCount('Completed'), getCount('Pending'), getCount('Cancelled'), getCount('Processing')],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                borderWidth: 0
            }]
        },
        options: { cutout: '70%', responsive: true, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } } }
    });
</script>