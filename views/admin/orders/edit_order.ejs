<style>
    /* Toast Animation Keyframes */
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<div id="toast-container" class="fixed top-24 right-4 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-100 mt-10">
    
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">Edit User Details</h2>
        <a href="/admin/users" class="text-sm text-gray-500 hover:text-gray-800">Cancel</a>
    </div>

    <form onsubmit="updateUser(event)" class="space-y-4">
        <input type="hidden" id="userId" value="<%= targetUser.id %>">
        
        <div>
            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Email Address</label>
            <input type="email" name="email" value="<%= targetUser.email %>" required
                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Role Permission</label>
            <select name="role" id="roleSelect" onchange="toggleLocation()" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="user" <%= targetUser.role === 'user' ? 'selected' : '' %>>User (Standard)</option>
                <option value="manager" <%= targetUser.role === 'manager' ? 'selected' : '' %>>Head Manager (All Access)</option>
                <option value="staff" <%= targetUser.role === 'staff' ? 'selected' : '' %>>Staff (POS Access)</option>
                <option value="store_manager" <%= targetUser.role === 'store_manager' ? 'selected' : '' %>>Local Store Manager</option>
            </select>
        </div>

        <div id="locationDiv" class="<%= (targetUser.role === 'store_manager' || targetUser.role === 'staff') ? '' : 'hidden' %>">
            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-orange-600">Assign Store Location</label>
            <select name="assigned_location_id" id="assignedLocationSelect" 
                class="w-full px-4 py-3 bg-orange-50 border border-orange-200 text-orange-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                <%= (targetUser.role === 'store_manager' || targetUser.role === 'staff') ? 'required' : '' %>>
                
                <option value="">-- Select Location --</option>
                <% locations.forEach(loc => { %>
                    <option value="<%= loc.id %>" 
                        <%= targetUser.assigned_location_id === loc.id ? 'selected' : '' %>>
                        <%= loc.name %>
                    </option>
                <% }) %>
            </select>
        </div>

        <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors">
            Update User
        </button>

    </form>
</div>

<script>
    // 1. NOTIFICATION SYSTEM
    function showNotification(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const isError = type === 'error';
        const bgClass = isError ? 'bg-red-500' : 'bg-green-500';
        const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';

        toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform pointer-events-auto min-w-[300px] border-2 border-white/20`;
        toast.style.animation = 'slideIn 0.5s forwards';
        
        toast.innerHTML = `
            <div class="text-2xl">${icon}</div>
            <div class="font-bold text-sm">${message}</div>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // 2. UPDATE USER
    async function updateUser(e) {
        e.preventDefault();
        const userId = document.getElementById('userId').value;
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch(`/admin/users/update/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if(res.ok) {
                showNotification('User Details Updated!', 'success');
                // Redirect back to user list after 1s
                setTimeout(() => window.location.href = '/admin/users', 1000);
            } else {
                showNotification('Error updating user', 'error');
            }
        } catch(err) {
            console.error(err);
            showNotification('Server Error', 'error');
        }
    }

    function toggleLocation() {
        const role = document.getElementById('roleSelect').value;
        const locDiv = document.getElementById('locationDiv');
        const locSelect = document.getElementById('assignedLocationSelect');

        // Check for BOTH roles
        if (role === 'store_manager' || role === 'staff') {
            locDiv.classList.remove('hidden');
            locSelect.setAttribute('required', 'true'); 
        } else {
            locDiv.classList.add('hidden');
            locSelect.removeAttribute('required');
            locSelect.value = ""; 
        }
    }
</script>