<% if (typeof user !== 'undefined' && (user.role === 'admin' || user.role === 'manager')) { %>
    <form method="GET" action="/admin/orders" class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col md:flex-row gap-4 items-end transition-colors">
        
        <div class="w-full md:w-auto">
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Filter Date</label>
            <input 
                type="date" 
                name="date" 
                value="<%= typeof query !== 'undefined' ? query.date : '' %>"
                class="w-full md:w-48 bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2 text-gray-700 focus:outline-none focus:border-indigo-500 transition-colors"
            />
        </div>

        <div class="w-full md:w-auto flex-1">
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Filter Location</label>
            <div class="relative">
                <select name="location" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-2 appearance-none text-gray-700 focus:outline-none focus:border-indigo-500 transition-colors">
                    <option value="">All Locations</option>
                    <% if (typeof locations !== 'undefined') { %>
                        <% locations.forEach(function(loc) { %>
                            <option value="<%= loc.id %>" <%= (typeof query !== 'undefined' && query.location == loc.id) ? 'selected' : '' %>>
                                <%= loc.name %>
                            </option>
                        <% }); %>
                    <% } else { %>
                        <option value="1">Main Branch</option>
                        <option value="2">Warehouse</option>
                    <% } %>
                </select>
                <div class="absolute right-3 top-2.5 text-gray-400 pointer-events-none">
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>

        <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2">
            <i class="fa-solid fa-filter"></i> Filter
        </button>
        
        <% if (typeof query !== 'undefined' && (query.date || query.location)) { %>
            <a href="/admin/orders" class="w-full md:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                Clear
            </a>
        <% } %>
    </form>
<% } %>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transition-colors">
  <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
    <h3 class="font-bold text-gray-800 dark:text-white text-lg">Order Management</h3>
    <span class="text-xs font-bold bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-400 px-2 py-1 rounded">
        Requests Priority
    </span>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-left">
      <thead class="bg-gray-50 dark:bg-gray-900 text-gray-500 dark:text-gray-400 text-sm">
        <tr>
          <th class="p-4">ID</th>
          <th class="p-4">Table</th>
          <th class="p-4">Customer Account</th> 
          <th class="p-4">Store</th>
          <th class="p-4">Total</th>
          <th class="p-4">Payment</th>
          <th class="p-4">Status</th>
          <th class="p-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
        <% if (orders.length > 0) { %>
            <% orders.forEach(order => { %>
              <tr class="<%= (order.status === 'Cancel Requested' || order.status === 'Refund Requested') ? 'bg-orange-50 dark:bg-orange-900/20' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50' %> transition-colors border-gray-100 dark:border-gray-700">
                
                <td class="p-4 font-mono text-xs text-gray-600 dark:text-gray-400">#<%= order.id %></td>
                
                <td class="p-4 font-bold text-indigo-600 dark:text-indigo-400">
                    <% if(order.table_number) { %>
                         Table <%= order.table_number %>
                    <% } else { %>
                        <span class="text-gray-400 text-xs">N/A</span>
                    <% } %>
                </td>

                <td class="p-4">
                    <div class="flex flex-col">
                        <% if(order.user_name) { %>
                            <span class="font-bold text-sm text-gray-800 dark:text-white"><%= order.user_name %></span>
                            <span class="text-xs text-gray-500 dark:text-gray-400"><%= order.email %></span>
                        <% } else { %>
                            <span class="text-sm text-gray-500 dark:text-gray-400 italic"><%= order.email || 'Guest User' %></span>
                        <% } %>
                    </div>
                </td>

                <td class="p-4 text-sm text-gray-800 dark:text-gray-300"><%= order.pickup_location %></td>
                <td class="p-4 font-bold text-gray-800 dark:text-white"><%= Number(order.total_price).toFixed(2) %> $</td>
                
                <td class="p-4">
                    <span class="px-2 py-1 rounded text-xs font-bold <%= order.payment_method === 'QR' ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400' : 'bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400' %>">
                        <%= order.payment_method %>
                    </span>
                </td>

                <td class="p-4">
                    <% 
                       let statusColor = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                       if(order.status === 'Completed') statusColor = 'bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400';
                       if(order.status === 'Cancelled') statusColor = 'bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-400';
                       if(order.status === 'Refunded') statusColor = 'bg-purple-100 text-purple-600 dark:bg-purple-900/40 dark:text-purple-400';
                       if(order.status === 'Pending') statusColor = 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/40 dark:text-yellow-400';
                       if(order.status === 'Processing') statusColor = 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400';
                       
                       // Warning color for requests
                       if(order.status === 'Cancel Requested' || order.status === 'Refund Requested') 
                           statusColor = 'bg-orange-500 text-white animate-pulse';
                    %>
                    <span class="px-2 py-1 rounded text-xs font-bold <%= statusColor %>">
                        <%= order.status %>
                    </span>
                </td>
                
                <td class="p-4 flex justify-end gap-2 items-center">
                    
                    <% if (order.status === 'Cancel Requested') { %>
                        <form action="/admin/orders/handle-request/<%= order.id %>" method="POST" class="flex gap-1">
                            <input type="hidden" name="action" value="approve_cancel">
                            <button class="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700 shadow-sm">
                                <i class="fa-solid fa-check mr-1"></i> Accept
                            </button>
                        </form>
                        <form action="/admin/orders/handle-request/<%= order.id %>" method="POST">
                            <input type="hidden" name="action" value="reject_cancel">
                            <button class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded text-xs font-bold hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm">
                                Reject
                            </button>
                        </form>
                    
                    <% } else if (order.status === 'Refund Requested') { %>
                        <form action="/admin/orders/handle-request/<%= order.id %>" method="POST" class="flex gap-1">
                            <input type="hidden" name="action" value="approve_refund">
                            <button class="px-3 py-1 bg-purple-600 text-white rounded text-xs font-bold hover:bg-purple-700 shadow-sm">
                                <i class="fa-solid fa-check mr-1"></i> Refund
                            </button>
                        </form>
                        <form action="/admin/orders/handle-request/<%= order.id %>" method="POST">
                            <input type="hidden" name="action" value="reject_refund">
                            <button class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded text-xs font-bold hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm">
                                Reject
                            </button>
                        </form>

                    <% } else { %>
                        <form action="/admin/orders/<%= order.id %>/status" method="POST" class="flex gap-1 mr-2">
                           <select name="status" class="text-xs border border-gray-200 dark:border-gray-600 rounded p-1 bg-white dark:bg-gray-700 text-gray-800 dark:text-white shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none" onchange="this.form.submit()">
                                <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                <option value="Completed" <%= order.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                <option value="Refunded" <%= order.status === 'Refunded' ? 'selected' : '' %>>Refunded</option>
                            </select>
                        </form>

                        <a href="/admin/orders/edit/<%= order.id %>" class="px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 text-xs font-bold transition flex items-center">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        
                        <form action="/admin/orders/delete/<%= order.id %>" method="POST" onsubmit="return confirm('Delete this order permanently?');">
                            <button type="submit" class="px-3 py-1 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/50 text-xs font-bold transition">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    <% } %>

                </td>
              </tr>
            <% }) %>
        <% } else { %>
            <tr>
                <td colspan="8" class="p-8 text-center text-gray-500 dark:text-gray-400">No orders found.</td>
            </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<button id="theme-toggle" class="fixed bottom-6 right-6 w-12 h-12 bg-gray-900 dark:bg-yellow-400 text-white dark:text-gray-900 rounded-full shadow-lg z-[9999] flex items-center justify-center transition-transform hover:scale-110 focus:outline-none">
    <i class="fa-solid fa-moon dark:hidden text-lg"></i>
    <i class="fa-solid fa-sun hidden dark:block text-lg"></i>
</button>

<script>
    // --- DARK MODE LOGIC ---
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
</script>