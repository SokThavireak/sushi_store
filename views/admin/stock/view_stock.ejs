<style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
</style>

<div id="toast-container" class="fixed top-24 right-4 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<div class="max-w-3xl mx-auto space-y-6">

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <form action="/admin/stock" method="GET" class="flex flex-col sm:flex-row gap-4 items-end">
            
            <div class="w-full sm:w-auto">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Date</label>
                <input 
                    type="date" 
                    name="date" 
                    value="<%= typeof query !== 'undefined' ? query.date : '' %>"
                    class="w-full sm:w-48 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-gray-700 focus:outline-none focus:border-indigo-500 transition-colors"
                />
            </div>

            <div class="w-full sm:w-auto flex-1">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Location</label>
                <div class="relative">
                    <select name="location" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 appearance-none text-gray-700 focus:outline-none focus:border-indigo-500 transition-colors">
                        <option value="">All Locations</option>
                        <% if (typeof locations !== 'undefined' && locations.length > 0) { %>
                            <% locations.forEach(function(loc) { %>
                                <option value="<%= loc.id %>" <%= (typeof query !== 'undefined' && query.location == loc.id) ? 'selected' : '' %>>
                                    <%= loc.name %>
                                </option>
                            <% }); %>
                        <% } else { %>
                            <option value="1">Main Branch</option>
                            <option value="2">Warehouse</option>
                            <option value="3">Kitchen</option>
                        <% } %>
                    </select>
                    <div class="absolute right-3 top-2.5 text-gray-400 pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2">
                <i class="fa-solid fa-filter"></i> Filter
            </button>
        </form>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-start mb-6 border-b pb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                    Request #<%= request.id %>
                    <% if (request.created_at) { %>
                        <span class="text-xs font-normal bg-gray-100 text-gray-500 px-2 py-1 rounded-full border border-gray-200">
                            <i class="fa-regular fa-calendar mr-1"></i>
                            <%= new Date(request.created_at).toLocaleDateString() %>
                        </span>
                    <% } %>
                </h2>
                <p class="text-gray-500 mt-1">Location: <span class="font-bold text-indigo-600"><%= request.location_name %></span></p>
                <p class="text-xs text-gray-400 mt-1">Status: <span class="font-bold"><%= request.status %></span></p>
            </div>
            <a href="/admin/stock" class="text-gray-500 hover:text-gray-800 text-sm font-medium flex items-center gap-1">
                <i class="fa-solid fa-arrow-left"></i> Back to List
            </a>
        </div>

        <div class="mb-8">
            <h3 class="font-bold text-gray-700 mb-3">Requested Items</h3>
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500">
                    <tr>
                        <th class="p-3">Category</th>
                        <th class="p-3">Item Name</th>
                        <th class="p-3 text-right">Quantity</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <% items.forEach(item => { %>
                        <tr>
                            <td class="p-3">
                                <% if(item.category === 'Cook') { %>
                                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">Cook</span>
                                <% } else { %>
                                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Drink</span>
                                <% } %>
                            </td>
                            <td class="p-3 font-medium text-gray-800"><%= item.item_name %></td>
                            <td class="p-3 text-right font-bold"><%= item.quantity %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <% if ((user.role === 'admin' || user.role === 'manager') && request.status === 'Pending') { %>
            <div class="flex gap-4 border-t pt-6">
                <form onsubmit="handleStatusUpdate(event, 'Confirmed')" class="flex-1">
                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition transform active:scale-95">
                        <i class="fa-solid fa-check mr-2"></i> Approve Request
                    </button>
                </form>

                <form onsubmit="handleStatusUpdate(event, 'Rejected')" class="flex-1">
                    <button type="submit" class="w-full py-3 bg-red-100 hover:bg-red-200 text-red-600 font-bold rounded-lg transition transform active:scale-95">
                        <i class="fa-solid fa-xmark mr-2"></i> Reject
                    </button>
                </form>
            </div>
        <% } %>
    </div>
</div>

<script>
    function showNotification(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const isError = type === 'error';
        const bgClass = isError ? 'bg-red-500' : 'bg-green-500';
        const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';
        toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform pointer-events-auto min-w-[300px] border-2 border-white/20`;
        toast.style.animation = 'slideIn 0.5s forwards';
        toast.innerHTML = `<div class="text-2xl">${icon}</div><div class="font-bold text-sm">${message}</div>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'slideOut 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, 3000);
    }

    async function handleStatusUpdate(e, status) {
        e.preventDefault();
        // Confirmation before rejecting
        if(status === 'Rejected' && !confirm("Are you sure you want to reject this request?")) return;
        try {
            const res = await fetch('/admin/stock/<%= request.id %>/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            if(res.ok) {
                const msg = status === 'Confirmed' ? "Request Approved!" : "Request Rejected";
                showNotification(msg, status === 'Confirmed' ? 'success' : 'error');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showNotification("Error updating status", "error");
            }
        } catch(err) {
            console.error(err);
            showNotification("Server Error", "error");
        }
    }
</script>